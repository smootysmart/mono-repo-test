name: Main Dispatcher

on:
  pull_request:
    branches: [ main, deploydb ]
    types: [ opened, synchronize ]

jobs:
  filter_paths:
    runs-on: ubuntu-latest
    outputs:
      frontend_changed: ${{ steps.filter.outputs.frontend }}
      backend_changed: ${{ steps.filter.outputs.backend }}
    steps:
      - uses: actions/checkout@v4
        # ใช้ fetch-depth: 0 เพื่อให้ paths-filter สามารถทำงานกับ Pull Request ได้อย่างแม่นยำ
        with:
          fetch-depth: 0 
      
      - name: Check for changed paths
        id: filter
        uses: dorny/paths-filter@v2
        with:
          filters: |
            frontend:
              - 'Vue-APP/**'
            backend:
              - 'GO-APP/**'

  backend_ci:
    name: Backend CI
    needs: filter_paths
    # เงื่อนไขการรัน
    if: ${{ needs.filter_paths.outputs.backend_changed == 'true' }} 
    uses: smootysmart/mono-repo-test/.github/workflows/reuse-ci.yml@main
    with:
      tag: latest
      directory: ./GO-APP
      project: backend
    secrets: 
      # การส่ง Secrets นั้นถูกต้องแล้ว
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

  frontend_ci:
    name: Frontend CI
    needs: filter_paths
    if: ${{ needs.filter_paths.outputs.frontend_changed == 'true' }} 
    uses: smootysmart/mono-repo-test/.github/workflows/reuse-ci.yml@main
    with:
      tag: latest
      directory: ./Vue-APP
      project: frontend
      
    secrets: 
      # การส่ง Secrets นั้นถูกต้องแล้ว
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

  # 4. Job ตรวจสอบสถานะ (State Check)
  # ใช้เพื่อยืนยันว่า Jobs ที่จำเป็นทั้งหมดรันเสร็จสิ้นแล้ว หรือ Jobs ถูกข้ามไป
  status_check:
    name: Final Status Check
    runs-on: ubuntu-latest
    needs: [backend_ci, frontend_ci]
    if: success() || failure() 
    steps:
      - run: echo "All necessary CI/CD workflows completed or skipped successfully."